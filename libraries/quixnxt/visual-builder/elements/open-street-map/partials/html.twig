
{% set id = advanced.identifier.id %}
{% set class = advanced.identifier.class %}
{% set views = general.configuration.views %}
{% set lat = general.configuration.latitude|default('23.77319') %}
{% set lon = general.configuration.longitude|default('90.36692') %}
{% set isGdprComplianceOn = isGdprComplianceEnabled() %}

{% set height = general.configuration.height %}
{% if height.value %}
    {% set height = height.value %}
{% endif %}

{% set classes = classNames('qx-element qx-element-map', visibilityClass(visibility), class ) %}
{% set animation = advanced.animation_fields_group.animation %}
{% set animationRepeat = advanced.animation_fields_group.animation_repeat %}
{% set animationDelay = advanced.animation_fields_group.animation_delay %}
{% set background = advanced.background_fields_group.background %}

{% embed "animation.twig" with {
    "id" : id,
    "classes" : classes,
    "animation" : animation,
    "animationRepeat" : animationRepeat,
    "animationDelay" : animationDelay,
    "background" : background
} %}
    {% block element %}
       {% if isGdprComplianceOn and renderer %}

        <div
          class="qx-flex qx-align-items-center qx-position-relative qx-text-center"
          style="
            min-width: 1140px;
            height: 407px;
            border-radius: 5px;
            overflow: hidden;
            background: url('media/quixnxt/images/open-street-map.png') no-repeat center;
          "
        >
          <div style="backdrop-filter: blur(4px) contrast(0.9); position: absolute; width: 100%; height: 100%;" ></div>
          <div style="
              background: white;
              z-index: 1;
              padding: 2rem;
              margin: 4rem;
              border-radius: 10px;
            "
          >
            <p>
              {{ JTranslate('COM_QUIX_GDPR_COMPLIANCE_OPEN_STREET_MAP_WARNING', "We value your privacy. Open Street Map may collect some of your personal data such as IP address and location. By clicking <strong>'Allow Open Street Map'</strong>, you consent to load Open Street Map. Your consent will be stored in local storage for future visits, and you can withdraw it anytime.") }}
            </p>
            <button
              style='border: none; padding: 0.6rem;'
              class="qx-btn-primary qx-btn-sm qx-allow-content-btn-{{ id }}">
              <strong>{{ JTranslate('COM_QUIX_GDPR_COMPLIANCE_OPEN_STREET_MAP_ALLOW', 'Allow Open Street Map') }}</strong>
            </button>
          </div>

        </div>

        <script>
          (() => {
            jQuery(document).ready(function () {
              const button = jQuery(".qx-allow-content-btn-{{ id }}");
              if(localStorage.getItem("allowGoogleMapLoad") === 'true') {
                jQuery(button).parent().parent().remove();
                loadMap();
                return;
              }
              window.allowGoogleMapButtons = (window.allowGoogleMapButtons ?? {});
              window.allowGoogleMapButtons["{{ id }}"] = button;
              button.on("loadMap", function () {
                jQuery(this).parent().parent().remove();
                loadMap();
              });
              button.click(function () {
                localStorage.setItem("allowGoogleMapLoad", 'true');
                jQuery(this).parent().parent().remove();
                loadMap();
                for(const btn in window.allowGoogleMapButtons) {
                  if(btn !== "{{ id }}") {
                    window.allowGoogleMapButtons[btn].trigger("loadMap");
                  }
                }
              });

            });
            function loadMap() {
              jQuery(".qx-open-street-map-container.{{ id }}-wrapper").html(`
                <div class="open-map-container">
                  <iframe
                      id="openMaps-{{id}}"
                      height={{height}}
                      width="100%"
                      scrolling="no"
                      src="https://www.openstreetmap.org/export/embed.html?bbox={{lon}}%2C{{lat}}%2C{{lon}}%2C{{lat}}&amp;layer={{views}}"marker="{{lat}}%2C{{lon}}"
                      >
                  </iframe>
                  <br/>
                  <small>
                      <a href="https://www.openstreetmap.org/#map=12/{{lat}}/{{lon}}&amp;layers=C" target="_blank">View Larger Map</a>
                  </small>
              </div>
              `);
            }
          })()

        </script>
      {% endif %}
      {% if isGdprComplianceOn and renderer %}
        <div class="qx-open-street-map-container {{ id }}-wrapper">
          <p><strong>Open Street Map</strong></p>
        </div>
      {% else%}
        <div class="open-map-container">
            <iframe
                id="openMaps-{{id}}"
                height={{height}}
                width="100%"
                frameborder="0"
                scrolling="no"
                marginheight="0"
                marginwidth="0"
                src="https://www.openstreetmap.org/export/embed.html?bbox={{lon}}%2C{{lat}}%2C{{lon}}%2C{{lat}}&amp;layer={{views}}"marker="{{lat}}%2C{{lon}}"
                >
            </iframe>
            <br/>
            <small>
                <a href="https://www.openstreetmap.org/#map=12/{{lat}}/{{lon}}&amp;layers=C" target="_blank">View Larger Map</a>
            </small>
        </div>
      {% endif %}
    {% endblock %}
{% endembed %}
